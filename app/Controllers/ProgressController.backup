<?php
namespace App\Controllers;

use App\Models\KeyresultModel;
use App\Models\ProgressModel;
use App\Models\ReportingPeriodModel;
use App\Models\ProgressCommentModel;
use App\Models\ProgressEntryModel;
use App\Models\KeyResultEntryModel;

class ProgressController extends TemplateController
{
    protected $allowed = [];

    public function index()
    {
        return redirect()->to(base_url('progress/list'));
    }

    public function list()
    {
        $progressModel = new ProgressModel();

        $conditions = [
            'department_id' => session('department'),
            'year' => '2568'
        ];

        $keyresults = $progressModel->getKeyResults([
            'conditions' => $conditions
        ]);


        // ดึงข้อมูลความคืบหน้าล่าสุดของแต่ละ Key Result
        foreach ($keyresults as &$keyresult) {
            $latestProgress = $progressModel->getLatestProgress($keyresult['key_result_id']);
            $keyresult['latest_progress'] = $latestProgress;

            // การตรวจสอบสิทธิ์
            $keyresult['can_report'] = canReportProgress($keyresult['key_result_id']);
            $keyresult['can_view'] = canViewKeyResult($keyresult['key_result_id']);
        }

        // ข้อมูลสิทธิ์สำหรับ View
        $this->data['user_permissions'] = getDepartmentUserRoles();
        $this->data['pending_approvals_count'] = getPendingApprovalsCount();

        $this->data['keyresults'] = $keyresults;
        $this->data['title'] = 'รายงานความคืบหน้า Key Results';
        $this->data['cssSrc'] = ['assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.css'];
        $this->data['jsSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.js',
            'assets/js/progress/list.js'
        ];

        $this->contentTemplate = 'progress/list';
        return $this->render();
    }

    public function view($keyResultId, $progressId = null)
    {

        // ตรวจสอบสิทธิ์การดู Key Result
        checkPermissionOrFail(
            canViewKeyResult($keyResultId),
            'คุณไม่มีสิทธิ์ดู Key Result นี้'
        );

        $progressModel = new ProgressModel();
        $reportingPeriodModel = new ReportingPeriodModel();
        $commentModel = new ProgressCommentModel();

        $keyresult = $progressModel->getKeyResultById($keyResultId);

        if (!$keyresult) {
            return redirect()->back()->with('error', 'ไม่พบข้อมูล Key Result');
        }

        // ดึงข้อมูลรอบการรายงาน
        $reportingPeriods = $reportingPeriodModel->getActiveReportingPeriods();

        // ดึงประวัติการรายงานทั้งหมด
        $progressHistory = $progressModel->getProgressHistory($keyResultId);

        // เพิ่มการดึงรายการข้อมูลที่เกี่ยวข้องสำหรับแต่ละรายงาน
        if (class_exists('\App\Models\ProgressEntryModel')) {
            $progressEntryModel = new \App\Models\ProgressEntryModel();
            foreach ($progressHistory as &$progress) {
                $relatedEntries = $progressEntryModel->getEntriesByProgressId($progress['id']);
                $progress['related_entries'] = $relatedEntries;

                // ✅ เพิ่มการตรวจสอบสิทธิ์สำหรับแต่ละรายงาน
                $progress['can_edit'] = ($progress['status'] === 'draft' && ($progress['created_by'] == session('user_id') || isAdmin()));
                $progress['can_approve'] = canApproveProgress($progress['id']);
                $progress['can_delete'] = ($progress['status'] === 'draft' && ($progress['created_by'] == session('user_id') || isAdmin()));
                $progress['can_submit'] = ($progress['status'] === 'draft' && $progress['created_by'] == session('user_id'));
            }
        }

        // ดึงข้อมูลความคืบหน้าตาม ID (ถ้ามี)
        $currentProgress = null;
        if ($progressId) {
            $currentProgress = $progressModel->getProgressById($progressId);
            if ($currentProgress) {
                $comments = $commentModel->getCommentsByProgressId($progressId);
                $currentProgress['comments'] = $comments;
            }
        }

        // เพิ่มข้อมูลสิทธิ์
        $this->data['keyresult'] = $keyresult;
        $this->data['reportingPeriods'] = $reportingPeriods;
        $this->data['progressHistory'] = $progressHistory;
        $this->data['currentProgress'] = $currentProgress;
        $this->data['can_report_progress'] = canReportProgress($keyResultId);
        $this->data['user_permissions'] = getDepartmentUserRoles();

        $this->data['title'] = 'ประวัติการรายงานความคืบหน้า';
        $this->data['cssSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.css',
            'assets/css/progress/view.css'
        ];
        $this->data['jsSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.js',
            'assets/js/progress/view.js'
        ];

        $this->contentTemplate = 'progress/view';
        return $this->render();
    }

    public function form($keyResultId, $reportingPeriodId = null, $progressId = null)
    {

        // ตรวจสอบสิทธิ์การรายงานความคืบหน้า
        checkPermissionOrFail(
            canReportProgress($keyResultId),
            'คุณไม่มีสิทธิ์รายงานความคืบหน้าสำหรับ Key Result นี้'
        );

        $progressModel = new ProgressModel();
        $reportingPeriodModel = new ReportingPeriodModel();
        $progressEntryModel = new ProgressEntryModel();
        $keyResultEntryModel = new KeyResultEntryModel();

        // ดึงข้อมูล Key Result
        $keyresult = $progressModel->getKeyResultById($keyResultId);

        if (!$keyresult) {
            return redirect()->back()->with('error', 'ไม่พบข้อมูล Key Result');
        }

        // ดึงข้อมูลรอบการรายงาน
        $reportingPeriods = $reportingPeriodModel->getActiveReportingPeriods();

        // ดึงรายการ entries ทั้งหมดของ Key Result นี้
        $allEntries = $keyResultEntryModel->where('key_result_id', $keyResultId)
                                        ->where('entry_status', 'published')
                                        ->orderBy('entry_name')
                                        ->findAll();

        // ข้อมูลสำหรับการแก้ไข
        $progress = null;
        $selectedEntries = [];
        $isEdit = false;

        if ($progressId) {
            $progress = $progressModel->find($progressId);

            if (!$progress) {
                return redirect()->back()->with('error', 'ไม่พบข้อมูลที่ต้องการแก้ไข');
            }


            // ตรวจสอบสิทธิ์การแก้ไข
            if ($progress['status'] !== 'draft') {
                return redirect()->back()->with('error', 'ไม่สามารถแก้ไขรายงานที่ส่งแล้วหรืออนุมัติแล้ว');
            }

            if ($progress['created_by'] != session('user_id') && !isAdmin()) {
                return redirect()->back()->with('error', 'คุณไม่มีสิทธิ์แก้ไขรายงานนี้');
            }

            if ($progress['key_result_id'] == $keyResultId) {
                $isEdit = true;
                // ดึงรายการ entries ที่เลือกไว้
                $selectedEntryObjects = $progressEntryModel->getEntriesByProgressId($progressId);
                $selectedEntries = array_column($selectedEntryObjects, 'entry_id');
            }
        }

        $this->data['keyresult'] = $keyresult;
        $this->data['reportingPeriods'] = $reportingPeriods;
        $this->data['progress'] = $progress;
        $this->data['is_edit'] = $isEdit;
        $this->data['key_result_id'] = $keyResultId;
        $this->data['reporting_period_id'] = $reportingPeriodId;
        $this->data['all_entries'] = $allEntries;
        $this->data['selected_entries'] = $selectedEntries;
        $this->data['user_permissions'] = getDepartmentUserRoles();

        $this->data['title'] = $isEdit ? 'แก้ไขรายงานความคืบหน้า' : 'บันทึกความคืบหน้า';
        $this->data['cssSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.css'
        ];
        $this->data['jsSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.js',
            'assets/js/progress/form.js'
        ];

        $this->contentTemplate = 'progress/form';
        return $this->render();
    }

    public function save()
    {
        $progressModel = new ProgressModel();
        $progressEntryModel = new ProgressEntryModel(); // ✅ เพิ่ม

        $keyResultId = $this->request->getPost('key_result_id');
        $reportingPeriodId = $this->request->getPost('reporting_period_id');

        // ดึงข้อมูล target_value สำหรับคำนวณเปอร์เซ็นต์
        $keyresult = $progressModel->getKeyResultById($keyResultId);
        $targetValue = $keyresult['target_value'] ?? 0;
        $progressValue = (float)$this->request->getPost('progress_value');

        // คำนวณเปอร์เซ็นต์ความคืบหน้า
        $progressPercentage = $targetValue > 0 ? ($progressValue / $targetValue) * 100 : 0;

        // หาเวอร์ชันถัดไป
        $nextVersion = $progressModel->getNextVersion($keyResultId, $reportingPeriodId);

        $data = [
            'key_result_id' => $keyResultId,
            'reporting_period_id' => $reportingPeriodId,
            'progress_value' => $progressValue,
            'progress_percentage' => round($progressPercentage, 2),
            'progress_description' => $this->request->getPost('progress_description'),
            'challenges' => $this->request->getPost('challenges'),
            'solutions' => $this->request->getPost('solutions'),
            'next_actions' => $this->request->getPost('next_actions'),
            'status' => $this->request->getPost('status') ?? 'draft',
            'version' => $nextVersion,
            'created_by' => session('user_id'),
            'created_date' => date('Y-m-d H:i:s')
        ];

        $progressId = $progressModel->insert($data);

        if ($progressId) {
            // ✅ บันทึกรายการ entries ที่เลือก
            $selectedEntries = $this->request->getPost('selected_entries');
            if ($selectedEntries && is_array($selectedEntries)) {
                $progressEntryModel->saveProgressEntries($progressId, $selectedEntries);
            }

            // บันทึกประวัติ
            $progressModel->insertHistory($progressId, 'created', 'สร้างรายงานความคืบหน้าใหม่', session('user_id'));

            return redirect()->to('/progress/view/' . $keyResultId)->with('success', 'บันทึกความคืบหน้าสำเร็จ');
        }

        return redirect()->back()->with('error', 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
    }


    public function update($progressId)
    {
        $progressModel = new ProgressModel();
        $progressEntryModel = new ProgressEntryModel();

        $progress = $progressModel->find($progressId);
        if (!$progress) {
            return redirect()->back()->with('error', 'ไม่พบข้อมูลที่ต้องการแก้ไข');
        }

        // ดึงข้อมูล target_value สำหรับคำนวณเปอร์เซ็นต์
        $keyresult = $progressModel->getKeyResultById($progress['key_result_id']);
        $targetValue = $keyresult['target_value'] ?? 0;
        $progressValue = (float)$this->request->getPost('progress_value');

        // คำนวณเปอร์เซ็นต์ความคืบหน้า
        $progressPercentage = $targetValue > 0 ? ($progressValue / $targetValue) * 100 : 0;

        $oldData = $progress;
        $newData = [
            'progress_value' => $progressValue,
            'progress_percentage' => round($progressPercentage, 2),
            'progress_description' => $this->request->getPost('progress_description'),
            'challenges' => $this->request->getPost('challenges'),
            'solutions' => $this->request->getPost('solutions'),
            'next_actions' => $this->request->getPost('next_actions'),
            'status' => $this->request->getPost('status') ?? 'draft',
            'updated_by' => session('user_id'),
            'updated_date' => date('Y-m-d H:i:s')
        ];

        if ($progressModel->update($progressId, $newData)) {
            // ✅ อัพเดทรายการ entries ที่เลือก
            $selectedEntries = $this->request->getPost('selected_entries');
            if ($selectedEntries && is_array($selectedEntries)) {
                $progressEntryModel->saveProgressEntries($progressId, $selectedEntries);
            } else {
                // ถ้าไม่มีการเลือก entries ให้ลบทั้งหมด
                $progressEntryModel->where('progress_id', $progressId)->delete();
            }

            // บันทึกประวัติการแก้ไข
            $progressModel->insertHistory(
                $progressId,
                'updated',
                'แก้ไขรายงานความคืบหน้า',
                session('user_id'),
                json_encode($oldData),
                json_encode($newData)
            );

            return redirect()->to('/progress/view/' . $progress['key_result_id'])->with('success', 'แก้ไขความคืบหน้าสำเร็จ');
        }

        return redirect()->back()->with('error', 'เกิดข้อผิดพลาดในการแก้ไขข้อมูล');
    }

    public function submit($progressId)
    {
        $progressModel = new ProgressModel();
        $progress = $progressModel->find($progressId);

        if (!$progress) {
            return $this->response->setJSON(['success' => false, 'message' => 'ไม่พบข้อมูล']);
        }

        // ตรวจสอบสิทธิ์การส่งรายงาน
        if ($progress['created_by'] != session('user_id') && !isAdmin()) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'คุณไม่มีสิทธิ์ส่งรายงานนี้'
            ]);
        }

        // ตรวจสอบสถานะ
        if ($progress['status'] !== 'draft') {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'รายงานนี้ถูกส่งไปแล้วหรืออนุมัติแล้ว'
            ]);
        }

        // ตรวจสอบความสมบูรณ์ของข้อมูล
        if (empty($progress['progress_value']) || $progress['progress_value'] <= 0) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'กรุณากรอกค่าความคืบหน้าก่อนส่งรายงาน'
            ]);
        }


        $data = [
            'status' => 'submitted',
            'submitted_by' => session('user_id'),
            'submitted_date' => date('Y-m-d H:i:s'),
            'updated_by' => session('user_id'),
            'updated_date' => date('Y-m-d H:i:s')
        ];

        if ($progressModel->update($progressId, $data)) {
            // บันทึกประวัติ
            $progressModel->insertHistory($progressId, 'submitted', 'ส่งรายงานเพื่อขออนุมัติ', session('user_id'));

            return $this->response->setJSON(['success' => true, 'message' => 'ส่งรายงานเพื่อขออนุมัติสำเร็จ']);
        }

        return $this->response->setJSON(['success' => false, 'message' => 'เกิดข้อผิดพลาด']);
    }

    public function approve($progressId)
    {

        // ตรวจสอบสิทธิ์การอนุมัติ
        if (!canApproveProgress($progressId)) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'คุณไม่มีสิทธิ์อนุมัติรายงานนี้'
            ]);
        }

        $progressModel = new ProgressModel();
        $progress = $progressModel->find($progressId);

        if (!$progress) {
            return $this->response->setJSON(['success' => false, 'message' => 'ไม่พบข้อมูล']);
        }

        // ตรวจสอบสถานะ
        if ($progress['status'] !== 'submitted') {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'รายงานนี้ยังไม่ได้ส่งหรืออนุมัติไปแล้ว'
            ]);
        }

        $data = [
            'status' => 'approved',
            'approved_by' => session('user_id'),
            'approved_date' => date('Y-m-d H:i:s'),
            'updated_by' => session('user_id'),
            'updated_date' => date('Y-m-d H:i:s')
        ];

        if ($progressModel->update($progressId, $data)) {
            // บันทึกประวัติ
            $progressModel->insertHistory($progressId, 'approved', 'อนุมัติรายงานความคืบหน้า', session('user_id'));

            return $this->response->setJSON(['success' => true, 'message' => 'อนุมัติรายงานสำเร็จ']);
        }

        return $this->response->setJSON(['success' => false, 'message' => 'เกิดข้อผิดพลาด']);
    }

    public function delete($progressId)
    {
        $progressModel = new ProgressModel();

        $progress = $progressModel->find($progressId);
        if (!$progress) {
            return $this->response->setJSON(['success' => false, 'message' => 'ไม่พบข้อมูล']);
        }

        try {

            // ลบข้อมูลในฐานข้อมูล (จะลบ comments และ history ด้วยเพราะมี CASCADE)
            $progressModel->delete($progressId);

            return $this->response->setJSON(['success' => true, 'message' => 'ลบรายงานสำเร็จ']);

        } catch (\Exception $e) {
            log_message('error', 'Delete progress error: ' . $e->getMessage());
            return $this->response->setJSON(['success' => false, 'message' => 'เกิดข้อผิดพลาด']);
        }
    }


    public function addComment()
    {
        $commentModel = new ProgressCommentModel();

        $data = [
            'progress_id' => $this->request->getPost('progress_id'),
            'comment_type' => $this->request->getPost('comment_type') ?? 'feedback',
            'comment_text' => $this->request->getPost('comment_text'),
            'commenter_role' => $this->request->getPost('commenter_role') ?? 'manager',
            'created_by' => session('user_id'),
            'created_date' => date('Y-m-d H:i:s')
        ];

        if ($commentModel->insert($data)) {
            return $this->response->setJSON(['success' => true, 'message' => 'เพิ่มความคิดเห็นสำเร็จ']);
        }

        return $this->response->setJSON(['success' => false, 'message' => 'เกิดข้อผิดพลาด']);
    }

    public function getProgressDetails($progressId)
    {
        $progressModel = new ProgressModel();
        $progressEntryModel = new ProgressEntryModel();
        $commentModel = new ProgressCommentModel();

        $progress = $progressModel->getProgressById($progressId);

        if (!$progress) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'ไม่พบข้อมูลรายงานความคืบหน้า'
            ]);
        }

        // ดึงรายการข้อมูลที่เกี่ยวข้อง
        $relatedEntries = $progressEntryModel->getEntriesByProgressId($progressId);
        $progress['entries'] = $relatedEntries;

        // ดึงความคิดเห็น
        $comments = $commentModel->getCommentsByProgressId($progressId);
        $progress['comments'] = $comments;

        return $this->response->setJSON([
            'success' => true,
            'progress' => $progress
        ]);
    }


    public function reject($progressId)
    {
        if (!canApproveProgress($progressId)) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'คุณไม่มีสิทธิ์ปฏิเสธรายงานนี้'
            ]);
        }

        $progressModel = new ProgressModel();
        $progress = $progressModel->find($progressId);

        if (!$progress || $progress['status'] !== 'submitted') {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'ไม่สามารถปฏิเสธรายงานนี้ได้'
            ]);
        }

        $rejectReason = $this->request->getPost('reject_reason');
        if (empty($rejectReason)) {
            return $this->response->setJSON([
                'success' => false,
                'message' => 'กรุณาระบุเหตุผลในการปฏิเสธ'
            ]);
        }

        $data = [
            'status' => 'rejected',
            'updated_by' => session('user_id'),
            'updated_date' => date('Y-m-d H:i:s')
        ];

        if ($progressModel->update($progressId, $data)) {
            // บันทึกประวัติพร้อมเหตุผล
            $progressModel->insertHistory(
                $progressId,
                'rejected',
                'ปฏิเสธรายงาน: ' . $rejectReason,
                session('user_id')
            );

            return $this->response->setJSON(['success' => true, 'message' => 'ปฏิเสธรายงานสำเร็จ']);
        }

        return $this->response->setJSON(['success' => false, 'message' => 'เกิดข้อผิดพลาด']);
    }

    // สำหรับดู pending approvals
    public function pendingApprovals()
    {
        if (!isApprover()) {
            return redirect()->back()->with('error', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
        }

        $progressModel = new ProgressModel();

        // ดึงรายงานที่รอการอนุมัติ
        $pendingApprovals = $this->getPendingApprovalsList();

        $this->data['pending_approvals'] = $pendingApprovals;
        $this->data['user_permissions'] = getDepartmentUserRoles();
        $this->data['title'] = 'รายงานที่รอการอนุมัติ';
        $this->data['cssSrc'] = ['assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.css'];
        $this->data['jsSrc'] = [
            'assets/themes/metronic38/assets/plugins/custom/datatables/datatables.bundle.js',
            'assets/js/progress/pending-approvals.js'
        ];
        $this->contentTemplate = 'progress/pending-approvals';
        return $this->render();
    }

    private function getPendingApprovalsList()
    {
        $db = \Config\Database::connect();

        $builder = $db->table('key_result_progress krp')
            ->select('
                krp.*,
                kr.name as key_result_name,
                u.full_name as creator_name,
                rp.quarter_name,
                rp.year
            ')
            ->join('key_results kr', 'krp.key_result_id = kr.id')
            ->join('users u', 'krp.created_by = u.id')
            ->join('reporting_periods rp', 'krp.reporting_period_id = rp.id')
            ->join('key_result_departments krd', 'kr.id = krd.key_result_id')
            ->where('krp.status', 'submitted')
            ->where('krd.department_id', session('department'))
            ->where('krd.role', 'Leader')
            ->where('krp.created_by !=', session('user_id')); // ไม่รวมรายงานของตัวเอง

        return $builder->orderBy('krp.submitted_date', 'ASC')
                      ->get()
                      ->getResultArray();
    }

}