<?php
namespace App\Models;

use CodeIgniter\Model;

class KeyresultModel extends Model
{
    protected $table = 'key_results'; // ใช้ table หลักไว้ก่อน
    protected $primaryKey = 'id';
    protected $returnType = 'array';

    // ไม่ต้องกำหนด allowedFields ถ้าใช้เฉพาะ get/query
    // protected $allowedFields = [...];

    public function getKeyResults($params = [])
    {
        $builder = $this->db->table('objective_groups og')
            ->select('
                og.id AS og_id, og.name AS og_name,
                obj.id AS objective_id, obj.sequence_no AS objective_sequence, obj.name AS objective_name,
                kt.id AS key_result_template_id, kt.sequence_no AS key_result_template_sequence, kt.name AS key_result_template_name,
                kr.id AS key_result_id, kr.key_result_year, kr.sequence_no AS key_result_sequence, kr.name AS key_result_name
            ')
            ->join('objectives obj', 'og.id = obj.objective_group_id')
            ->join('key_result_templates kt', 'kt.objective_id = obj.id')
            ->join('key_results kr', 'kr.key_result_template_id = kt.id')
            ->join('key_result_departments kd', 'kr.id = kd.key_result_id');

        // เงื่อนไข dynamic
        if (!empty($params['conditions']['key_result_id'])) {
            $builder->where('kr.id', $params['conditions']['key_result_id']);
        }

        if (!empty($params['conditions']['department_id'])) {
            $builder->where('kd.department_id', $params['conditions']['department_id']);
        }

        if (!empty($params['conditions']['year'])) {
            $builder->where('kr.key_result_year', $params['conditions']['year']);
        }

        // ค้นหาด้วย keyword
        if (!empty($params['keyword'])) {
            $keyword = trim($params['keyword']);
            $builder->groupStart()
                ->like('kr.name', $keyword)
                ->orLike('kt.name', $keyword)
                ->orLike('obj.name', $keyword)
                ->groupEnd();
        }

        // นับจำนวนรายการอย่างเดียว
        if (!empty($params['count_only'])) {
            return $builder->countAllResults();
        }

        // Pagination
        if (!empty($params['limit'])) {
            $builder->limit($params['limit'], $params['offset'] ?? 0);
        }

        // เรียงลำดับ
        $builder->orderBy('og.id')
                ->orderBy('obj.sequence_no')
                ->orderBy('kt.sequence_no')
                ->orderBy('kr.sequence_no');

        return $builder->get()->getResultArray();
    }

    public function getDepartmentsByKeyResult($key_result_id)
    {
        return $this->db->table('key_result_departments kd')
            ->select('kd.role, d.short_name, d.name AS full_name')
            ->join('departments d', 'kd.department_id = d.id')
            ->where('kd.key_result_id', $key_result_id)
            ->get()
            ->getResultArray();
    }


}
